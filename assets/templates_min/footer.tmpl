{{define "public/footer"}}
<script defer>const $uploadButton=document.getElementById("uploadButton"),$response=document.getElementById("response"),$loading=document.getElementById("loading"),$uploadFile=document.getElementById("uploadFile"),$uploadFileLabel=document.getElementById("uploadFileLabel"),$copyCodeButtons_text=".copy-code";function uploadFile(e){const t=20971520,n=e.name,o=e=>console.log(e),l=e=>{console.error(e);const t=`上传失败(${e.message})`;return $response.prepend(createResponseElement(t,"response-error")),Promise.reject("Upload failed")};if(e.size<=t)uploadImg(e,1).then(o).catch(l);else{let o,a=`tgstate-blob\n${n}`;const d=(l,s,r=0)=>{if(l<e.size){return uploadImg(e.slice(l,s),0,o).then((n=>(a+=`\n${n.substring(14)}`,l=s,s=Math.min(l+t,e.size),d(l,s))),(e=>{if(r<5)return o=`${n}上传块失败，2秒后重试 (${r+1}/5)`,console.warn(o),new Promise((e=>setTimeout(e,2e3))).then((()=>d(l,s,r+1)));throw console.error(`${n}上传块失败，已达到最大重试次数 (5)`),e}))}return Promise.resolve()};d(0,t).then((()=>{console.log(a);const e=new Blob([a],{type:"text/plain"});return uploadImg(new File([e],`${n}_fileAll.txt`,{type:"text/plain"}),1)})).catch(l)}}function uploadImg(e,t,n){const o=e.name;return new Promise(((l,a)=>{const d=new FormData;d.append("file",e);const s=e.type.startsWith("image/");$uploadButton.disabled=!0,$uploadButton.textContent=`${o}上传中`,$loading.style.display="block";const r=window.location.origin;fetch(`${r}/api`,{method:"POST",body:d,headers:{}}).then((e=>e.json())).then((e=>{const d=`${r}${e.message}?filename=${o}`,i=document.createElement("div");return 1===e.code?(t&&(s?(i.className="response-item response-success",i.innerHTML=`${o}上传成功，图片外链：<a target="_blank" href="${d}">${d}</a><div class="copy-links">\n                                        <span class="copy-code" data-clipboard-text="&lt;img src=&quot;${d}&quot; alt=&quot;Your Alt Text&quot;&gt;">HTML</span>\n                                        <span class="copy-code" data-clipboard-text="![Alt Text](${d})">Markdown</span>\n                                        <span class="copy-code" data-clipboard-text="[img]${d}[/img]">BBCode</span>\n                                    </div>`):(i.className="response-item response-success",i.innerHTML=`${o}上传成功，文件外链：<a target="_blank" href="${d}">${d}</a>`)),l(e.message)):(i.className="response-item response-error",i.textContent=n||`${o}上传失败(${e.message})`,a(`${o}上传失败(${e.message})`)),i.className&&$response.prepend(i),$uploadFile.value="",$uploadFileLabel.textContent="选择文件或拖拽到此区域",$uploadFileLabel.style.backgroundColor="#007BFF",document.querySelectorAll($copyCodeButtons_text).forEach((function(e){e.addEventListener("click",(function(){let e=this.dataset.clipboardText,t=document.createElement("input");document.body.appendChild(t),t.value=e,t.select(),document.execCommand("copy"),document.body.removeChild(t);let n=this,o=n.textContent;n.textContent="复制成功",setTimeout((function(){n.textContent=o}),500)}))})),e.message})).catch((e=>{let t=document.createElement("div");t.className="response-item response-error",t.textContent=`${o}上传失败`,$response.appendChild(t),a(`${o}上传失败`)})).finally((()=>{$uploadButton.disabled=!1,$uploadButton.textContent="上传",$loading.style.display="none"}))}))}function readAndUploadFile(e){const t=new FileReader;t.onload=function(t){const n=t.target.result;uploadFile(e,n)},t.readAsText(e)}function handleFileSelection(e){e.length>0?1===e.length?($uploadFileLabel.textContent="已选择文件: "+e[0].name,$uploadFileLabel.style.backgroundColor="#0056b3"):($uploadFileLabel.textContent="已选择多个文件",$uploadFileLabel.style.backgroundColor="#0056b3"):($uploadFileLabel.textContent="选择文件或拖拽到此区域",$uploadFileLabel.style.backgroundColor="#007BFF")}document.addEventListener("DOMContentLoaded",(function(){$uploadFile.addEventListener("change",(function(){handleFileSelection(this.files)})),$uploadButton.addEventListener("click",(function(){if($uploadFile.files.length>0)for(let e=0;e<$uploadFile.files.length;e++)readAndUploadFile($uploadFile.files[e]);else alert("请至少选择一个文件")}));let e=0;document.documentElement.addEventListener("dragover",(function(e){e.preventDefault()})),document.documentElement.addEventListener("dragenter",(function(t){t.preventDefault(),0===e&&(document.documentElement.style.backgroundColor="rgba(0, 123, 255, 0.1)"),e++})),document.documentElement.addEventListener("dragleave",(function(t){e--,0===e&&(document.documentElement.style.backgroundColor="transparent")})),document.documentElement.addEventListener("drop",(function(t){t.preventDefault(),document.documentElement.style.backgroundColor="transparent",$uploadFile.files=t.dataTransfer.files,handleFileSelection(t.dataTransfer.files),e=0}))}))</script>
{{end}}